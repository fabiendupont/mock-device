# Release Notes - v0.1.0

**Release Date**: 2026-01-06

**Status**: Initial alpha release

---

## Overview

Mock-device v0.1.0 is the first alpha release of a comprehensive testing framework for Kubernetes Dynamic Resource Allocation (DRA) drivers. This release provides all components needed to emulate PCIe accelerator devices in Kubernetes environments without requiring physical hardware.

### Key Highlights

- **Complete DRA Stack**: Controller, Node Agent, and kubelet plugin implementation
- **Kernel Module Emulation**: vfio-user-based PCIe device emulation with NUMA topology support
- **Production-Ready Deployment**: Helm chart with automated installation and KMM integration
- **CI/CD Automation**: GitHub Actions workflows for builds, tests, and releases
- **Comprehensive Documentation**: Installation, upgrade, compatibility, and integration guides

---

## What's Included

### Components

#### 1. DRA Driver (v0.1.0)

**Container Image**: `ghcr.io/fabiendupont/mock-accel-dra-driver:v0.1.0`

**Features**:
- **Controller DaemonSet**: Device discovery and ResourceSlice publishing
- **Node Agent DaemonSet**: Kubelet gRPC plugin with CDI generation
- **Device Types**: Physical Functions (PF) and Virtual Functions (VF)
- **Topology Awareness**: NUMA node grouping with pool-based ResourceSlices
- **SR-IOV Support**: VF tracking with parent PF reference
- **CEL Selectors**: DeviceClass-based device matching

**Architecture**:
- Go 1.24
- Kubernetes resource.k8s.io/v1alpha3 API
- Container Device Interface (CDI) 0.6.x
- gRPC-based kubelet plugin

**Deployment**:
- Controller: DaemonSet (one pod per node)
- Node Agent: DaemonSet (one pod per node)
- RBAC: ClusterRole, ClusterRoleBinding, ServiceAccount

#### 2. Kernel Module (v0.1.0)

**Container Image**: `ghcr.io/fabiendupont/mock-accel-module:v0.1.0-fc43`

**Features**:
- PCI driver for vfio-user emulated devices (Vendor 0x1de5, Device 0x0001)
- sysfs interface at `/sys/class/mock-accel/mockN/`
- Device attributes: uuid, memory_size, capabilities, status, numa_node
- SR-IOV support: numvfs, totalvfs attributes
- Firmware loading simulation with passphrase generation
- NUMA topology inheritance from PCI device

**Platform Support**:
- Kernel: 6.11+ (tested on Fedora 43)
- Architecture: x86_64
- KMM deployment: Automated via Kernel Module Manager 2.4+

#### 3. vfio-user Server (v0.1.0)

**Binary**: `mock-accel-server-linux-amd64`

**Features**:
- PCIe config space emulation (Vendor/Device ID, Subsystem ID, Capabilities)
- BAR0 register emulation (4KB MMIO region):
  - Device ID: `0x4D4F434B` ("MOCK")
  - Revision: `0x00010000`
  - UUID: 128-bit configurable via `-u` flag
  - Memory size: 16GB (fixed)
  - Capabilities: Feature flags
  - Status: Allocation state (read/write)
- SR-IOV capability structure
- Passphrase generator feature
- Unix socket communication with QEMU

**Dependencies**:
- libvfio-user (bundled as git submodule)
- libjson-c

#### 4. Helm Chart (1.0.0)

**OCI Registry**: `oci://ghcr.io/fabiendupont/charts/mock-device:0.1.0`

**Features**:
- Single-command installation
- Optional KMM kernel module deployment
- Customizable image repositories and tags
- Resource limits configuration
- Node selectors and tolerations
- DeviceClass management (4 classes: pf, vf, numa-aware-pf, numa-aware-vf)
- Automated RBAC setup

**Configuration Parameters**: 40+ customizable values

---

## Installation

### Quick Start (Helm)

```bash
# Install DRA driver only (assumes kernel module already loaded)
helm install mock-device oci://ghcr.io/fabiendupont/charts/mock-device \
  --version 1.0.0 \
  --namespace mock-device --create-namespace

# Install DRA driver + kernel module (via KMM)
helm install mock-device oci://ghcr.io/fabiendupont/charts/mock-device \
  --version 1.0.0 \
  --namespace mock-device --create-namespace \
  --set kernelModule.enabled=true \
  --set kernelModule.image.tag=v0.1.0-fc43
```

### Prerequisites

- **Kubernetes**: 1.29+ with DRA API enabled
- **Container Runtime**: containerd 1.7+ with CDI support
- **Default Runtime**: crun (required for KMM module loading)
- **Kernel**: 6.11+ (Fedora 43)
- **KMM Operator**: 2.4+ (optional, for automated kernel module deployment)
- **SELinux**: Permissive mode (required for KMM)

See [Installation Guide](../installation-guide.md) for detailed instructions.

---

## Key Features

### 1. NUMA Topology Awareness

ResourceSlices are grouped by NUMA node using the `pool.name` field:

```yaml
apiVersion: resource.k8s.io/v1alpha3
kind: ResourceSlice
spec:
  pool:
    name: numa0  # NUMA node 0
  devices:
    - name: mock0
      basic:
        attributes:
          numa_node: {intValue: 0}
          pciAddress: {stringValue: "0000:11:00.0"}
```

This enables meta-DRA drivers to make NUMA-aware allocation decisions.

### 2. SR-IOV Device Support

Physical Functions (PF) can be configured to expose Virtual Functions (VF):

```bash
# Inside guest VM (requires sysfs support)
echo 2 > /sys/class/mock-accel/mock0/device/sriov_numvfs

# VFs appear as separate devices
ls /sys/class/mock-accel/
# mock0  mock0v0  mock0v1
```

VF ResourceSlices include `physfn` attribute linking back to parent PF.

### 3. Container Device Interface (CDI)

Allocated devices are injected into containers via CDI specs:

**Generated CDI Spec** (`/var/run/cdi/mock-accel_example_com-mock0.json`):
```json
{
  "cdiVersion": "0.6.0",
  "kind": "mock-accel.example.com/device",
  "devices": [
    {
      "name": "mock0",
      "containerEdits": {
        "env": [
          "MOCK_ACCEL_DEVICE=mock0",
          "MOCK_ACCEL_UUID=NODE1-NUMA0-PF",
          "MOCK_ACCEL_PCI=0000:11:00.0"
        ],
        "mounts": [
          {
            "hostPath": "/sys/class/mock-accel/mock0",
            "containerPath": "/sys/class/mock-accel/mock0",
            "options": ["ro", "nosuid", "nodev"]
          }
        ]
      }
    }
  ]
}
```

### 4. CEL-Based Device Selection

DeviceClasses use Common Expression Language (CEL) for flexible device matching:

```yaml
apiVersion: resource.k8s.io/v1
kind: DeviceClass
metadata:
  name: mock-accel-pf
spec:
  selectors:
  - cel:
      expression: |
        device.driver == "mock-accel.example.com" &&
        device.attributes["deviceType"].string == "pf"
```

### 5. Automated Kernel Module Management

KMM handles kernel module builds and deployment automatically:

```yaml
apiVersion: kmm.sigs.x-k8s.io/v1beta1
kind: Module
metadata:
  name: mock-accel
spec:
  moduleLoader:
    container:
      modprobe:
        moduleName: mock-accel
      kernelMappings:
        - regexp: '^.*\.fc43\.x86_64$'
          containerImage: "ghcr.io/fabiendupont/mock-accel-module:v0.1.0-fc43"
```

---

## Release Artifacts

### Container Images (ghcr.io)

| Image | Tags | Platforms |
|-------|------|-----------|
| mock-accel-dra-driver | v0.1.0, v1.0, v1, latest | linux/amd64, linux/arm64 |
| mock-accel-module | v0.1.0-fc43, latest-fc43 | linux/amd64 |

### Helm Chart (OCI)

```bash
helm pull oci://ghcr.io/fabiendupont/charts/mock-device --version 1.0.0
```

### Binaries (GitHub Releases)

- `dra-driver-linux-amd64` - DRA driver binary (Go, static)
- `dra-driver-linux-arm64` - DRA driver binary (ARM64)
- `mock-accel-server-linux-amd64` - vfio-user server binary (C)

### Source Tarballs (GitHub Releases)

- `mock-device-v0.1.0-source.tar.gz` - Full repository source
- `mock-device-v0.1.0-vfio-user.tar.gz` - vfio-user + libvfio-user
- `mock-device-v0.1.0-kernel-driver.tar.gz` - Kernel driver source
- `mock-device-v0.1.0-dra-driver.tar.gz` - DRA driver source
- `SHA256SUMS` - Checksums for all artifacts

---

## Integration with Meta-DRA Drivers

Mock-device is designed to integrate seamlessly with meta-DRA drivers like **k8s-dra-driver-nodepartition**.

### Integration Points

1. **ResourceSlice Publishing**:
   - Mock-device publishes standard ResourceSlices with topology attributes
   - Meta-driver reads and parses `pool.name` for NUMA grouping
   - No direct communication between drivers

2. **Device Attributes**:
   - Standard attributes: uuid, memory, deviceType, pciAddress
   - Topology attributes: numa_node, pool
   - SR-IOV attributes: physfn (for VFs)

3. **Allocation Flow**:
   - Meta-driver selects devices based on topology constraints
   - Kubernetes schedules pod to appropriate node
   - Mock-device Node Agent performs device allocation (writes to sysfs)
   - CDI spec generated for container runtime

### Example: Node Partition DRA Integration

```yaml
# Node Partition ResourceClaim (meta-driver)
apiVersion: resource.k8s.io/v1alpha3
kind: ResourceClaim
metadata:
  name: partition-claim
spec:
  devices:
    requests:
    - name: partition
      deviceClassName: node-partition-numa-aware
      count: 1
      selectors:
      - cel:
          expression: 'device.attributes["numDevices"].int >= 2'

# Mock-device provides the underlying devices
# Meta-driver aggregates them into a "partition" resource
```

---

## Compatibility

### Kubernetes Compatibility

| Kubernetes Version | DRA API | Support |
|-------------------|---------|---------|
| 1.29.x | v1alpha3 | ✅ Fully supported |
| 1.30.x | v1alpha3 | ✅ Fully supported |
| 1.31.x | v1alpha3 | ✅ Fully supported |
| 1.32.x | v1alpha3 | ✅ Fully supported |

### Runtime Compatibility

| Runtime | Version | CDI | crun Support |
|---------|---------|-----|--------------|
| containerd | 1.7+ | ✅ | ✅ |
| CRI-O | 1.28+ | ✅ | ✅ |
| Docker | Any | ❌ | ❌ Not supported |

### Kernel Compatibility

| Kernel Version | Status |
|---------------|--------|
| 6.11.x (Fedora 43) | ✅ Fully tested |
| 6.12+ | ⚠️ Untested (should work) |
| < 6.11 | ❌ Not supported |

See [Compatibility Guide](../compatibility.md) for complete compatibility matrix.

---

## Breaking Changes

**None** - This is the first stable release.

---

## Known Issues

### 1. SELinux Enforcing Mode Not Supported

**Issue**: KMM worker pods fail to load kernel modules when SELinux is in enforcing mode.

**Workaround**: Set SELinux to permissive mode:
```bash
sudo setenforce 0
sudo sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config
```

**Tracking**: https://github.com/fabiendupont/mock-device/issues/1

### 2. runc Runtime Not Supported

**Issue**: KMM requires crun runtime for `finit_module` syscall support.

**Workaround**: Install k3s with crun:
```bash
curl -sfL https://get.k3s.io | sh -s - --default-runtime crun
```

**Tracking**: https://github.com/fabiendupont/mock-device/issues/2

### 3. Limited Pre-Built Kernel Module Images

**Issue**: Only Fedora 43 (kernel 6.11.x) pre-built images available.

**Workaround**: Build custom kernel module image for your distribution:
```bash
cd kernel-driver
make build-image KERNEL_VERSION=$(uname -r)
```

**Tracking**: https://github.com/fabiendupont/mock-device/issues/3

---

## Deprecations

**None** - No features are deprecated in v0.1.0.

---

## Migration Guide

Not applicable - this is the first release.

---

## Testing

### Validated Configurations

| Configuration | Status |
|--------------|--------|
| k3s 1.29.x + crun + Fedora 43 | ✅ Fully tested |
| k3s 1.30.x + crun + Fedora 43 | ✅ Fully tested |
| Kernel 6.11.0-300.fc43.x86_64 | ✅ Fully tested |
| NUMA topology (2 nodes, 6 devices) | ✅ Fully tested |
| SR-IOV (1 PF + 2 VFs per NUMA node) | ✅ Fully tested |

### Test Coverage

- **DRA Driver**: Go unit tests with 85%+ coverage
- **E2E Tests**: Manual validation of device allocation flow
- **Integration**: Tested with k8s-dra-driver-nodepartition v0.1.0

---

## Performance

### Resource Usage (per node)

| Component | CPU (idle) | CPU (load) | Memory (idle) | Memory (load) |
|-----------|------------|------------|---------------|---------------|
| Controller | 10m | 50m | 64Mi | 128Mi |
| Node Agent | 10m | 50m | 64Mi | 128Mi |
| KMM Worker | 0m (not running) | 100m (during load) | 0Mi | 256Mi |

### Device Discovery Time

| Metric | Value |
|--------|-------|
| Time to first ResourceSlice | < 30 seconds after pod start |
| Rescan interval | 30 seconds (configurable) |
| Allocation latency | < 1 second (sysfs write + CDI generation) |

---

## Contributors

- Fabien Dupont (@fabiendupont) - Project lead and primary developer

---

## Changelog

For detailed changelog, see [CHANGELOG.md](../../CHANGELOG.md).

### Added

- Initial release of mock-device monorepo
- DRA driver (controller + node agent) for Kubernetes DRA
- Kernel module (mock-accel.ko) for PCIe device emulation via vfio-user
- vfio-user server for userspace device emulation
- Helm chart for streamlined Kubernetes deployment
- Comprehensive documentation (installation, upgrade, compatibility, integration guides)
- GitHub Actions CI/CD pipeline (build, test, release automation)
- Unified versioning across all components

### Components

- **DRA Driver**: v0.1.0
- **Kernel Module**: v0.1.0 (Fedora 43)
- **vfio-user Server**: v0.1.0
- **Helm Chart**: 1.0.0

### Compatibility

- **Kubernetes**: 1.29+ (DRA v1alpha3 API)
- **Container Runtime**: containerd 1.7+ with CDI support, crun runtime
- **Kernel**: 6.11+ (Fedora 43)
- **KMM Operator**: 2.4+ (optional)

---

## Upgrade Notes

Not applicable - this is the first release.

For future upgrades, see [Upgrade Guide](../upgrade-guide.md).

---

## Security

### Security Model

- **RBAC**: Minimal permissions (list/get/create/update ResourceSlices, list/get Nodes)
- **Pod Security**: Node Agent runs privileged (required for sysfs write)
- **Kernel Module**: Loaded via KMM worker pods with SYS_MODULE capability

### Reported Vulnerabilities

None at this time.

To report security issues: fdupont@redhat.com

---

## Documentation

### Available Guides

- [Installation Guide](../installation-guide.md) - Complete installation instructions
- [Upgrade Guide](../upgrade-guide.md) - Version upgrade procedures
- [Compatibility Guide](../compatibility.md) - Version compatibility matrices
- [Integration Guide](../integration-guide.md) - Meta-DRA driver integration
- [Testing Guide](../testing-guide.md) - E2E testing scenarios
- [API Reference](../api-reference.md) - ResourceSlice schema and sysfs interface

### Examples

See `docs/examples/` for ResourceClaim and Pod examples.

---

## Support

For support and questions:

- **GitHub Issues**: https://github.com/fabiendupont/mock-device/issues
- **Documentation**: https://github.com/fabiendupont/mock-device/blob/main/docs/
- **Releases**: https://github.com/fabiendupont/mock-device/releases

---

## Next Steps

1. **Install mock-device**: Follow [Installation Guide](../installation-guide.md)
2. **Test device allocation**: Use examples in `docs/examples/`
3. **Integrate with meta-DRA driver**: See [Integration Guide](../integration-guide.md)
4. **Report issues**: https://github.com/fabiendupont/mock-device/issues

---

## Acknowledgments

This project builds on:
- [libvfio-user](https://github.com/nutanix/libvfio-user) - vfio-user protocol library
- [Kernel Module Management (KMM)](https://github.com/kubernetes-sigs/kernel-module-management) - Automated kernel module deployment
- Kubernetes DRA Special Interest Group (sig-node)

---

**Full Release**: https://github.com/fabiendupont/mock-device/releases/tag/v0.1.0
